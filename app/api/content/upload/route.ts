import { NextRequest } from 'next/server'; import { prisma } from '@/lib/prisma'; export const runtime='nodejs'; function toTitle(n:string){return n.replace(/[_-]+/g,' ').replace(/\.[^.]+$/,'');} export async function POST(req:NextRequest){ const cid=req.cookies.get('companyId')?.value; if(!cid) return new Response(JSON.stringify({error:'NO_AUTH'}),{status:401}); const form=await req.formData(); const files=form.getAll('files') as File[]; if(!files?.length) return new Response(JSON.stringify({error:'NO_FILES'}),{status:400}); const allowed=new Set(['text/plain','text/markdown','text/csv','application/json']); for(const file of files){ if(!allowed.has(file.type)) continue; const ab=await file.arrayBuffer(); const text=new TextDecoder().decode(new Uint8Array(ab)); await prisma.document.create({data:{companyId:cid, source:'upload', title:toTitle(file.name), text}}); } return new Response(JSON.stringify({ok:true})); }