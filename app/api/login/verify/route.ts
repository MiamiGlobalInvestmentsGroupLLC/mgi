import { NextRequest } from 'next/server'; import { prisma } from '@/lib/prisma'; export const runtime='nodejs'; export async function POST(req:NextRequest){ const { email, otp } = await req.json(); if(!email||!otp) return new Response(JSON.stringify({error:'Missing'}),{status:400}); const item = await prisma.otp.findFirst({ where:{ email, code: otp, consumed:false }, orderBy:{ createdAt:'desc' } }); if(!item) return new Response(JSON.stringify({error:'Invalid'}),{status:401}); if(item.expiresAt < new Date()) return new Response(JSON.stringify({error:'Expired'}),{status:401}); const company = item.companyId ? await prisma.company.findUnique({where:{id:item.companyId}}) : await prisma.company.findFirst({ where:{ email } }); await prisma.otp.update({ where:{ id:item.id }, data:{ consumed:true } }); return new Response(JSON.stringify({ success:true }), { headers:{ 'Set-Cookie': `companyId=${company?.id}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=2592000` }}); }